{% extends "democracy/base_club_banner.html" %}
{% load static %}
{% load staticfiles %}
{% load widget_tweaks %}
{% load i18n %}

{% block styles %}
{% load static %}
<link rel="stylesheet" href="{% static 'democracy/css/base_club_banner.css' %}">
<link rel="stylesheet" href="{% static 'democracy/css/candidate_films.css' %}">
{% endblock %}

{% block title %}{% trans 'Voting results' %}{% endblock %}

{% block content %}


<h1 class="display-4">{% trans 'Film ranking' %}</h1>


<!--START: PARTICIPANTS-->
<div class="participants-header">
  <h3 class="h3">{% trans 'Participants' %}</h3>
  <hr>
  <div class="row mx-1 justify-content-center">
    {% for participant in participants %}
    <div class="col-auto">
      {% if participant.profile_image %}
      <img class="participant-picture my-2 border border-secondary rounded-circle" title="{{ participant.username }}"
           src="{{ participant.profile_image.url }}"
           alt="participant.profile_image not found">
      {% else %}
      <img class="participant-picture my-2 border border-secondary rounded-circle" title="{{ participant.username }}"
           src="{% static 'registration/svg/user_no_profile_image.svg' %}" alt="participant.profile_image not found">
      {% endif %}
    </div>
    {% endfor %}
  </div>
</div>
<!--END: PARTICIPANTS-->


{% for message in messages %}
<div class="alert {{ message.tags }} alert-dismissible text-center mt-n1 mb-4 mx-2" role="alert">
  <button type="button" class="close" data-dismiss="alert" aria-label="Close">
    <span aria-hidden="true">&times;</span>
  </button>
  <span class="ml-4"><strong>{{ message }}</strong></span>
</div>
{% endfor %}


<!--START: VOTING RESULTS-->

<div class="container p-1 m-0" style="max-width: 100%">
  <table class="table table-hover table-ranking">
    <thead class="thead-light">
    <tr>
      <th scope="col" class="text-center"><span class="">#</span></th>
      <th scope="col">{% trans 'Film' %}</th>
      <th scope="col" class="text-center">{% trans 'Duration' %}</th>
      <th scope="col" class="text-center">{% trans 'Results' %}</th>
    </tr>
    </thead>
    <tbody>

    {% for film_results in films_results|dictsortreversed:"points" %}

    <tr class="">
      <!--# COLUMN-->
      <td class="text-center align-middle">{{ forloop.counter }}</td>

      <!--TITLE COLUMN-->
      <td class="align-middle">
        <a class="strong-link" href="{% url 'democracy:film_detail' club.id film_results.id 'all' 'title' %}">
          {{ film_results.title }}
        </a>
      </td>

      <!--DURATION COLUMN-->
      <td class="text-center align-middle">{{ film_results.duration }}</td>

      <!--RESULTS COLUMN-->
      <td class="text-center align-middle">

        <div class='results-box pointer-cursor border border-secondary rounded p-1 m-n1' data-toggle="modal"
             data-target="#FilmResultsModal_{{ forloop.counter }}">

          <div class="row justify-content-center">

            {% if film_results.positive_votes|length > 0 %}
            <div class="col-auto">
              <strong>{{ film_results.positive_votes|length }}</strong>
              <img class="ml-1 mt-n1 rounded rounded-circle border border-secondary" style="height: 20px;"
                   src="{% static 'democracy/svg/thumbsupwhite.svg'%}">
            </div>
            {% endif %}

            {% if film_results.negative_votes|length > 0 %}
            <div class="col-auto">
              <strong>{{ film_results.negative_votes|length }}</strong>
              <img class="ml-1 mt-n1 rounded rounded-circle border border-secondary" style="height: 20px;"
                   src="{% static 'democracy/svg/thumbsdownwhite.svg'%}">
            </div>
            {% endif %}

            {% if film_results.abstentionists|length > 0 %}
            <div class="col-auto">
              <strong>{{ film_results.abstentionists|length }}</strong>
              <img class="ml-1 mt-n1" style="height: 22px;" src="{% static 'democracy/svg/question.svg'%}">
            </div>

            {% endif %}

            {% if film_results.warnings %}
            <div class="col-auto">
              <strong>{{ film_results.warnings|length }}</strong>
              <img class="ml-1 mt-n1" style="height: 19px;" src="{% static 'democracy/svg/alert.svg'%}">
            </div>
            {% endif %}
          </div>
        </div>


      </td>

    </tr>


    <!--START: RESULTS MODAL-->
    <div class="modal fade" id="FilmResultsModal_{{ forloop.counter }}" tabindex="-1" role="dialog"
         aria-labelledby="FilmResultsModal_{{ forloop.counter }}_Title" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
        <div class="modal-content modal-results">
          <div class="modal-header modal-results-header">
            <h5 class="modal-title" id="FilmResultsModal_{{ forloop.counter }}_Title">
              {% trans 'Results for:' %} {{ film_results.title }}</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body modal-results">

            <div class="text-center mt-2 mb-4">
              <strong>{% trans 'Film score:' %}</strong> {{ film_results.points }}
            </div>

            <!--START VOTES-->
            {% if film_results.positive_votes or film_results.positive_votes %}

            <div class="container-results mx-2">

              <!--START POSITIVE VOTES-->
              {% for vote in film_results.positive_votes %}

              <div class="media post my-2">
                <div class="align-self-start mr-3 user-image">
                  {% if vote.user.profile_image %}
                  <div>
                    <img class="border border-secondary rounded-circle" title="{{ vote.user.username }}"
                         src="{{ vote.user.profile_image.url }}"
                         alt="vote.user.profile_image not found">
                    {% else %}
                    <img class="border border-secondary rounded-circle" title="{{ vote.user.username }}"
                         src="{% static 'registration/svg/user_no_profile_image.svg' %}"
                         alt="vote.user.profile_image not found">
                    {% endif %}
                    <img class="hand-icon rounded-circle mt-n3 ml-4" style="height: 18px;"
                         src="{% static 'democracy/svg/thumbsupwhite.svg'%}">
                  </div>
                </div>
                <div class="">
                  <p class="my-0 post-text py-1 pl-2 pr-3 border rounded-lg">
                    <a class="strong-link" href="{% url 'democracy:club_member_detail' club.id vote.user.id %}">
                      {{ vote.user.username }}</a>:
                    <span>{{ vote.get_choice_display }}</span>
                  </p>
                </div>
              </div>

              {% endfor %}
              <!--END POSITIVE VOTES-->

              <!--START NEGATIVE VOTES-->
              {% for vote in film_results.negative_votes %}

              <div class="media post my-2">
                <div class="align-self-start mr-3 user-image">
                  {% if vote.user.profile_image %}
                  <img class="border border-secondary rounded-circle" title="{{ vote.user.username }}"
                       src="{{ vote.user.profile_image.url }}"
                       alt="vote.user.profile_image not found">
                  {% else %}
                  <img class="border border-secondary rounded-circle" title="{{ vote.user.username }}"
                       src="{% static 'registration/svg/user_no_profile_image.svg' %}"
                       alt="vote.user.profile_image not found">
                  {% endif %}
                  <img class="hand-icon rounded-circle mt-n3 ml-4" style="height: 18px;"
                       src="{% static 'democracy/svg/thumbsdownwhite.svg'%}">
                </div>
                <div class="">
                  <p class="my-0 post-text py-1 pl-2 pr-3 border rounded-lg">
                    <a class="strong-link" href="{% url 'democracy:club_member_detail' club.id vote.user.id %}">
                      {{ vote.user.username }}</a>:
                    <span>{{ vote.get_choice_display }}</span>
                  </p>
                </div>
              </div>

              {% endfor %}

            </div>
            <!--END NEGATIVE VOTES-->

            {% endif %}
            <!--END VOTES-->


            <!--START ABSTENTIONISTS-->
            {% if film_results.abstentionists %}

            <div class="modal-results-section mx-auto mt-n4">
              <h3 class="h3">{% trans 'Did not vote' %}</h3>
              <hr>
            </div>

            <div class="row mx-1 justify-content-center">
              {% for participant in film_results.abstentionists %}
              <div class="col-auto align-items-center">
                {% if participant.profile_image %}
                <img class="voter-picture border border-secondary rounded-circle" title="{{ participant.username }}"
                     src="{{ participant.profile_image.url }}" alt="participant.profile_image not found">
                {% else %}
                <img class="voter-picture border border-secondary rounded-circle" title="{{ participant.username }}"
                     src="{% static 'registration/svg/user_no_profile_image.svg' %}"
                     alt="participant.profile_image not found">
                {% endif %}
              </div>
              {% endfor %}
            </div>

            {% endif %}
            <!--END ABSTENTIONISTS-->

            <!--START WARNING-->
            {% if film_results.warnings %}

            <div class="modal-results-section mx-auto mt-n4">
              <h3 class="h3">{% trans 'Warnings' %}</h3>
              <hr>
            </div>

            {% for warning in film_results.warnings %}
            <div class="text-center my-2 mx-4">
              {% if warning.type == 'veto' %}
              {% blocktrans with user=warning.voter film=warning.film %}
              <strong>{{ user }}</strong> vetoed the film <strong>{{ film }}</strong>.
              {% endblocktrans %}
              {% elif warning.type == 'omg' %}
              {% blocktrans with user=warning.voter film=warning.film %}
              Remember that <strong>{{ user }}</strong> really really wants to see <strong>{{ film }}</strong>.
              {% endblocktrans %}
              {% elif warning.type == 'proposer missing' %}
              {% blocktrans with user=warning.voter film=warning.film %}
              Keep in mind that <strong>{{ user }}</strong> proposed <strong>{{ film }}</strong>, and is not present.
              {% endblocktrans %}
              {% endif %}
            </div>
            {% endfor %}

            {% endif %}
            <!--END WARNING-->

          </div>
        </div>
      </div>
    </div>
    <!-- END: RESULTS MODAL-->


    {% endfor %}
    </tbody>
  </table>
</div>
<!--END: VOTING RESULTS-->


<form class="btn-cancel" action="{% url 'democracy:club_detail' club.id %}">
  <button type="submit" class="btn btn-sm">{% trans 'Back to club' %}</button>
</form>


{% endblock %}